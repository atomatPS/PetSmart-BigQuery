// Difficult to combine with other metrics, will probably have to run seperatley 


SELECT 
  event_date,
  FORMAT_TIMESTAMP('%H', DATETIME(TIMESTAMP_MICROS(event_timestamp), 'America/Phoenix')) as hour,
  SUM(CASE WHEN event_name = 'purchase' THEN items.quantity END) AS items_purchased
    FROM
      `petsmart-web-ecom.analytics_287660050.events_*`, UNNEST (items) AS items
      where _TABLE_SUFFIX = FORMAT_DATE ("%Y%m%d", DATE_SUB(CURRENT_DATE('America/Phoenix'), INTERVAL 2 DAY))
      GROUP BY event_date, hour
      ORDER BY event_date





// Code for Intra-Day Items Purchased 

SELECT
US_today as date, 
US_hour as hour,
US_items_purchased + CA_items_purchased as items_purchased
FROM(
with US as ( 
  SELECT
  CURRENT_DATE('America/Phoenix') as US_today,
  PARSE_DATE('%Y%m%d', event_date) as US_date,
  FORMAT_TIMESTAMP('%H', DATETIME(TIMESTAMP_MICROS(event_timestamp), 'America/Phoenix')) as US_hour,
  SUM(CASE WHEN event_name = 'purchase' THEN items.quantity END) AS US_items_purchased
    FROM
      `petsmart-web-ecom.analytics_287660050.events_intraday_*`, UNNEST (items) AS items
      GROUP BY US_date, US_hour
      ORDER BY US_hour ASC
),
CA as (
  SELECT
  CURRENT_DATE('America/Phoenix') as CA_today,
  PARSE_DATE('%Y%m%d', event_date) as CA_date, 
  FORMAT_TIMESTAMP('%H', DATETIME(TIMESTAMP_MICROS(event_timestamp), 'America/Phoenix')) as CA_hour,
  SUM(CASE WHEN event_name = 'purchase' THEN items.quantity END) AS CA_items_purchased
    FROM
      `petsmart-web-ecom.analytics_339409281.events_intraday_*`, UNNEST (items) AS items
      GROUP BY CA_date, CA_hour
      ORDER BY CA_hour ASC
)
SELECT * FROM US 
inner join CA on US_hour = CA_hour and US_date = CA_date
ORDER BY US_hour ASC
)
WHERE US_today = US_date
